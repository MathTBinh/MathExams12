
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>WebRTC + Firebase Demo</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
  <h2>ðŸŽ§ WebRTC + Firebase Audio Chat</h2>
  <p>Room ID: <input id="room-id" value="room1"> <button onclick="joinRoom()">Join Room</button></p>
  <p><strong>Status:</strong> <span id="status">Not connected</span></p>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD-PLACE-YOUR-KEY-HERE",
      authDomain: "your-app.firebaseapp.com",
      databaseURL: "https://your-app-default-rtdb.firebaseio.com",
      projectId: "your-app",
      storageBucket: "your-app.appspot.com",
      messagingSenderId: "000000000000",
      appId: "1:000000000000:web:xxxxxx"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const peerConnection = new RTCPeerConnection({
      iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    });
    let localStream;

    peerConnection.onicecandidate = event => {
      if (event.candidate) {
        db.ref(`rooms/${roomId}/candidates/${role}`).push(JSON.stringify(event.candidate));
      }
    };

    peerConnection.ontrack = event => {
      const remoteAudio = new Audio();
      remoteAudio.srcObject = event.streams[0];
      remoteAudio.play();
    };

    let role = "";
    let roomId = "";

    async function joinRoom() {
      roomId = document.getElementById("room-id").value;
      document.getElementById("status").innerText = "Connecting...";

      localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

      const roomRef = db.ref(`rooms/${roomId}`);
      const snapshot = await roomRef.once("value");

      if (snapshot.exists() && snapshot.val().offer) {
        // Join as callee
        role = "callee";
        const offer = JSON.parse(snapshot.val().offer);
        await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        await roomRef.update({ answer: JSON.stringify(answer) });
      } else {
        // Join as caller
        role = "caller";
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        await roomRef.set({ offer: JSON.stringify(offer) });
      }

      // Listen for answer
      roomRef.child("answer").on("value", async snap => {
        const val = snap.val();
        if (val && role === "caller") {
          const answer = JSON.parse(val);
          await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
        }
      });

      // Listen for ICE candidates
      roomRef.child("candidates").child(role === "caller" ? "callee" : "caller").on("child_added", snap => {
        const candidate = new RTCIceCandidate(JSON.parse(snap.val()));
        peerConnection.addIceCandidate(candidate);
      });

      document.getElementById("status").innerText = "Connected";
    }
  </script>
</body>
</html>
